<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Village Help</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial; background:#f2f2f2; }
.container {
  max-width:420px; margin:auto; background:#fff;
  padding:20px; margin-top:20px; border-radius:10px;
}
input, select, button {
  width:100%; padding:10px; margin-top:10px;
}
button {
  background:#28a745; color:#fff; border:none; font-size:16px;
}
button:disabled {
  background:#aaa;
}
.card {
  background:#eef6ff; padding:12px; margin-top:12px;
  border-radius:6px;
}
.status {
  font-weight:bold;
}
.pending { color:#ff9800; }
.accepted { color:#2196f3; }
.completed { color:#4caf50; }
.call { background:#007bff; margin-top:8px; }
hr { margin:15px 0; }
</style>
</head>

<body>
<div class="container">
  <h2>Village Help</h2>

  <!-- BOOKING FORM -->
  <div id="bookingForm">
    <select id="service">
      <option value="">Service ‡§ö‡•Å‡§®‡•á‡§Ç</option>
      <option>Electrician</option>
      <option>Plumber</option>
    </select>

    <input id="name" placeholder="‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ">
    <input id="mobile" placeholder="Mobile ‡§®‡§Ç‡§¨‡§∞ (10 digit)">
    <input id="village" placeholder="‡§ó‡§æ‡§Å‡§µ ‡§ï‡§æ ‡§®‡§æ‡§Æ">

    <button onclick="book()">Service Book ‡§ï‡§∞‡•á‡§Ç</button>
  </div>

  <!-- ACTIVE BOOKING -->
  <div id="activeBooking"></div>

  <hr>

  <!-- BOOKING HISTORY -->
  <h3>üìú ‡§Ü‡§™‡§ï‡•Ä Booking History</h3>
  <div id="history">Mobile number ‡§°‡§æ‡§≤‡•á‡§Ç</div>
</div>

<script>
/* üî• SAME FIREBASE PROJECT AS ADMIN + WORKER */
const firebaseConfig = {
  apiKey: "AIzaSyDOBjOo5YsBndo8HPQv66ClmthIHqf0gmw",
  authDomain: "village-help-6dda3.firebaseapp.com",
  projectId: "village-help-6dda3",
  storageBucket: "village-help-6dda3.firebasestorage.app",
  messagingSenderId: "242196617492",
  appId: "1:242196617492:web:a1dde8b7a42088f75b0a01"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* üîí Prevent duplicate active booking */
async function hasActiveBooking(mobile) {
  const snap = await db.collection("bookings")
    .where("mobile","==",mobile)
    .where("status","in",["pending","accepted"])
    .get();
  return !snap.empty;
}

/* üì¶ BOOK SERVICE */
async function book() {
  const service = serviceEl().value;
  const name = nameEl().value.trim();
  const mobile = mobileEl().value.trim();
  const village = villageEl().value.trim();

  if (!service || !name || !mobile || !village) {
    alert("‡§∏‡§≠‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç");
    return;
  }
  if (mobile.length !== 10) {
    alert("10 digit mobile number ‡§°‡§æ‡§≤‡•á‡§Ç");
    return;
  }

  if (await hasActiveBooking(mobile)) {
    alert("‡§Ü‡§™‡§ï‡•Ä ‡§è‡§ï booking ‡§™‡§π‡§≤‡•á ‡§∏‡•á active ‡§π‡•à");
    return;
  }

  const workerSnap = await db.collection("workers")
    .where("service","==",service)
    .where("active","==",true)
    .limit(1)
    .get();

  if (workerSnap.empty) {
    alert("‡§Ö‡§≠‡•Ä worker ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à");
    return;
  }

  const worker = workerSnap.docs[0].data();

  await db.collection("bookings").add({
    name, mobile, village, service,
    workerName: worker.name,
    workerMobile: worker.mobile,
    status: "pending",
    time: new Date()
  });

  watchBookings(mobile);
}

/* üîÅ LIVE BOOKINGS (STATUS + HISTORY) */
function watchBookings(mobile) {
  db.collection("bookings")
    .where("mobile","==",mobile)
    .orderBy("time","desc")
    .onSnapshot(snap => {
      let activeHTML = "";
      let historyHTML = "";

      snap.forEach(doc => {
        const d = doc.data();
        const statusClass =
          d.status === "accepted" ? "accepted" :
          d.status === "completed" ? "completed" : "pending";

        const card = `
          <div class="card">
            <b>${d.service}</b><br>
            Worker: ${d.workerName}<br>
            Village: ${d.village}<br>
            Status:
            <span class="status ${statusClass}">
              ${d.status || "pending"}
            </span><br>
            <a href="tel:${d.workerMobile}">
              <button class="call">üìû Worker Call</button>
            </a>
          </div>
        `;

        if (d.status === "pending" || d.status === "accepted") {
          activeHTML = card;
          document.getElementById("bookingForm").style.display = "none";
        } else {
          historyHTML += card;
        }
      });

      document.getElementById("activeBooking").innerHTML =
        activeHTML || "‡§ï‡•ã‡§à active booking ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à";

      document.getElementById("history").innerHTML =
        historyHTML || "‡§ï‡•ã‡§à ‡§™‡•Å‡§∞‡§æ‡§®‡•Ä booking ‡§®‡§π‡•Ä‡§Ç";

      if (!activeHTML) {
        document.getElementById("bookingForm").style.display = "block";
      }
    });
}

/* Helpers */
const serviceEl = () => document.getElementById("service");
const nameEl = () => document.getElementById("name");
const mobileEl = () => document.getElementById("mobile");
const villageEl = () => document.getElementById("village");

/* Auto load history when mobile entered */
mobileEl().addEventListener("blur", () => {
  const m = mobileEl().value.trim();
  if (m.length === 10) watchBookings(m);
});
</script>

</body>
</html>
