<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Village Help</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: Arial; background:#f2f2f2; }
    .container { max-width:420px; margin:auto; background:#fff; padding:20px; margin-top:20px; border-radius:10px; }
    input, select, button { width:100%; padding:10px; margin-top:10px; }
    button { background:#28a745; color:#fff; border:none; font-size:18px; }
    .confirm { display:none; background:#e8f8f5; padding:15px; margin-top:15px; }
    .call { background:#007bff; margin-top:10px; }
  </style>
</head>

<body>
<div class="container">
  <h2>Village Help</h2>

  <select id="service">
    <option value="">Service ‡§ö‡•Å‡§®‡•á‡§Ç</option>
    <option>Electrician</option>
    <option>Plumber</option>
  </select>

  <input id="name" placeholder="‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ">
  <input id="mobile" placeholder="Mobile ‡§®‡§Ç‡§¨‡§∞">
  <input id="village" placeholder="‡§ó‡§æ‡§Å‡§µ ‡§ï‡§æ ‡§®‡§æ‡§Æ">

  <button onclick="book()">Service Book ‡§ï‡§∞‡•á‡§Ç</button>

  <div class="confirm" id="confirm">
    <h3>‚úÖ Booking Confirm</h3>
    <p id="info"></p>
    <a id="callWorker">
      <button class="call">üìû Worker ‡§ï‡•ã Call ‡§ï‡§∞‡•á‡§Ç</button>
    </a>
    <a href="tel:9999999999">
      <button class="call">üìû Admin ‡§ï‡•ã Call ‡§ï‡§∞‡•á‡§Ç</button>
    </a>
  </div>
</div>

<script>
/* üî• SAME FIREBASE PROJECT AS ADMIN + WORKER */
const firebaseConfig = {
  apiKey: "AIzaSyDOBjOo5YsBndo8HPQv66ClmthIHqf0gmw",
  authDomain: "village-help-6dda3.firebaseapp.com",
  projectId: "village-help-6dda3",
  storageBucket: "village-help-6dda3.firebasestorage.app",
  messagingSenderId: "242196617492",
  appId: "1:242196617492:web:a1dde8b7a42088f75b0a01"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

async function book() {
  const service = document.getElementById("service").value;
  const name = document.getElementById("name").value.trim();
  const mobile = document.getElementById("mobile").value.trim();
  const village = document.getElementById("village").value.trim();

  if (!service || !name || !mobile || !village) {
    alert("‡§∏‡§≠‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§≠‡§∞‡•á‡§Ç");
    return;
  }

  if (mobile.length !== 10) {
    alert("10 digit mobile number ‡§°‡§æ‡§≤‡•á‡§Ç");
    return;
  }

  /* üîé FIND ACTIVE WORKER OF SAME SERVICE */
  const workerSnap = await db.collection("workers")
    .where("service", "==", service)
    .where("active", "==", true)
    .limit(1)
    .get();

  if (workerSnap.empty) {
    alert("‡§Ö‡§≠‡•Ä worker ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à");
    return;
  }

  const workerDoc = workerSnap.docs[0];
  const worker = workerDoc.data();

  /* üì¶ SAVE BOOKING */
  await db.collection("bookings").add({
    name: name,
    mobile: mobile,
    village: village,
    service: service,
    workerName: worker.name,
    workerMobile: worker.mobile, // üî• 10 digit, SAME AS WORKER PANEL
    status: "pending",
    time: new Date()
  });

  /* ‚úÖ CONFIRMATION */
  document.getElementById("info").innerHTML = `
    <b>Service:</b> ${service}<br>
    <b>Worker:</b> ${worker.name}<br>
    <b>Village:</b> ${village}
  `;

  document.getElementById("callWorker").href = "tel:" + worker.mobile;
  document.getElementById("confirm").style.display = "block";
}
</script>

</body>
</html>
